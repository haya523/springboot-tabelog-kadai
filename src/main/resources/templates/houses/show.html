<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ja">
<head>
    <meta charset="UTF-8">
    <title th:text="'NAGOYAMESHI | ' + ${house.name}">NAGOYAMESHI | 店舗詳細</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<header th:replace="~{fragment :: header}"></header>

<main class="samuraitravel-container container py-3">
    <!-- パンくず：中央寄せにするため breadcrumb-center を追加 -->
    <nav class="mb-3 breadcrumb-center" aria-label="breadcrumb">
        <a th:href="@{/}">ホーム</a> <span>›</span>
        <a th:href="@{/houses}">店舗一覧</a> <span>›</span>
        <strong th:text="${house.name}">店舗名</strong>
    </nav>

    <section class="show-wrap"
             th:with="
               imgName=${house.imageName},
               seeded=${imgName != null and (
                   imgName=='yakiniku.jpg' or imgName=='yakiniku02.jpg' or imgName=='yakiniku03.jpg' or
                   imgName=='yakitori01.jpg' or imgName=='yakitori02.jpg' or
                   imgName=='ramen.jpg' or imgName=='ramen02.jpg' or
                   imgName=='udon.jpg' or imgName=='sakana.jpg' or
                   imgName=='washoku.jpg' or imgName=='fried.jpg' or imgName=='don.jpg' or
                   imgName=='nagoyaburger.jpg' or imgName=='oden.jpg' or
                   imgName=='noImage.png'
               )}">
        <h1 class="show-title" th:text="${house.name}">店舗名</h1>

        <!-- 画像は中央寄せ＆固定幅（最大100%） -->
        <div class="show-hero">
            <img class="samuraitravel-show-image" alt="店舗画像"
                 th:src="${seeded} ? @{/images/{f}(f=${imgName})} : @{/images/noImage.png}"
                 th:attr="onerror=|this.onerror=null;this.src='@{/images/noImage.png}'|">
        </div>

        <!-- ▼ お気に入り：ログイン時のみ表示。isFavorite で出し分け -->
        <div class="fav-actions" sec:authorize="isAuthenticated()">
            <!-- 追加ボタン（未お気に入り時） -->
            <form th:if="${!isFavorite}" th:action="@{/favorites/add}" method="post">
                <input type="hidden" name="houseId" th:value="${house.id}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <button type="submit" class="samuraitravel-btn">★ お気に入りに追加</button>
            </form>

            <!-- 解除ボタン（お気に入り済み時） -->
            <form th:if="${isFavorite}" th:action="@{/favorites/remove}" method="post">
                <input type="hidden" name="houseId" th:value="${house.id}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <button type="submit" class="samuraitravel-btn-danger">★ お気に入り解除</button>
            </form>
        </div>

        <p class="show-desc" th:text="${house.description}">説明文</p>

        <dl class="show-spec">
            <div><dt>カテゴリ</dt>
                 <dd th:text="${house.categoryId != null ? categories[house.categoryId] : '未分類'}">未分類</dd></div>
            <div><dt>料金</dt><dd><span th:text="${#numbers.formatInteger(house.price, 3, 'COMMA')}">0</span>円〜</dd></div>
            <div><dt>定員</dt><dd th:text="${house.capacity}">0</dd></div>
            <div><dt>郵便番号</dt><dd th:text="${house.postalCode}">000-0000</dd></div>
            <div><dt>住所</dt><dd th:text="${house.address}">住所</dd></div>
            <div><dt>電話番号</dt><dd th:text="${house.phoneNumber}">000-000-000</dd></div>
        </dl>

        <!-- ==================== レビュー表示／投稿 ==================== -->
        <section id="reviews" class="reviews">
            <h2 class="reviews-title">レビュー</h2>

            <!-- フラッシュメッセージ -->
            <p th:if="${successMessage}" th:text="${successMessage}" style="color:#2e7d32; font-weight:600;"></p>
            <p th:if="${errorMessage}" th:text="${errorMessage}" style="color:#c62828; font-weight:600;"></p>

            <!-- 概要（平均点と件数） -->
            <div class="reviews-summary"
                 th:with="a=${averageRating != null ? averageRating : 0}, c=${reviewCount != null ? reviewCount : 0}">
                <div class="stars" style="font-size:1.1rem;">
                    <span th:each="i : ${#numbers.sequence(1, 5)}"
                          th:text="${i <= T(java.lang.Math).round(a) ? '★' : '☆'}">★</span>
                </div>
                <div class="meta" style="color:#555;">
                    <span th:text="${#numbers.formatDecimal(a, 1, 1) + ' / 5.0'}">0.0 / 5.0</span>
                    <span class="count" th:text="${'（' + c + '件）'}">（0件）</span>
                    <a th:href="@{|/reviews/house/${house.id}|}" class="samuraitravel-link" style="margin-left:8px;">すべてのレビューを見る</a>
                </div>
            </div>

            <!-- レビュー一覧 -->
            <div class="reviews-list" th:if="${reviews != null}">
                <div class="review-item" th:each="r : ${reviews}" style="border-top:1px solid #eee; padding:10px 0;">
                    <div class="review-head" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <span class="stars" th:with="rating=${r.rating}" style="font-size:1rem;">
                          <span th:each="i : ${#numbers.sequence(1, 5)}"
                                th:text="${i <= rating ? '★' : '☆'}">★</span>
                        </span>

                        <!-- ▼ レビュアー名（名前が無ければメール、ユーザー不在なら退会表示） -->
                        <span class="author" style="font-weight:600;"
                              th:text="${r.user != null ? ((r.user.name != null && !#strings.isEmpty(r.user.name)) ? r.user.name : r.user.email) : '（退会ユーザー）'}">
                          山田太郎
                        </span>

                        <!-- 自分のレビューならマーク -->
                        <span sec:authorize="isAuthenticated()"
                              th:if="${r.user != null and r.user.email != null and #authentication.name == r.user.email}"
                              style="font-size:0.9rem; color:#2e7d32;">（あなた）</span>

                        <small style="color:#777;"
                               th:text="${#dates.format(r.createdAt, 'yyyy/MM/dd HH:mm')}"
                               th:if="${r.createdAt != null}">2025/01/01 12:00</small>
                    </div>

                    <p class="comment samuraitravel-pre-wrap" th:text="${r.comment}">コメント</p>

                    <!-- ▼ 自分のレビューなら編集/削除操作を表示 -->
                    <div class="review-actions"
                         sec:authorize="isAuthenticated()"
                         th:if="${r.user != null and r.user.email != null and #authentication.name == r.user.email}"
                         style="display:flex; gap:12px; align-items:center;">
                        <a th:href="@{|/reviews/${r.id}/edit|}" class="samuraitravel-link">編集</a>

                        <form th:action="@{|/reviews/${r.id}/delete|}" method="post" style="display:inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button type="submit" class="samuraitravel-btn-danger"
                                    onclick="return confirm('このレビューを削除しますか？')">削除</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 投稿フォーム（ログイン時のみ表示）→ 自分のレビューがある場合は非表示 -->
            <div class="review-form"
                 sec:authorize="isAuthenticated()"
                 th:if="${!hasMyReview}"
                 style="margin-top:14px;">
                <h3 style="font-size:1.1rem; margin-bottom:8px;">レビューを投稿する</h3>
                <form th:action="@{|/reviews/house/${house.id}|}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <div class="field" style="margin-bottom:8px;">
                        <label for="rating">評価</label>
                        <select id="rating" name="rating" required>
                            <!-- 5→1 の順を維持（ビュー上の見やすさのため） -->
                            <option th:each="i : ${#numbers.sequence(5,1)}"
                                    th:value="${i}"
                                    th:text="${i + ' 点'}">5 点</option>
                        </select>
                    </div>
                    <div class="field" style="margin-bottom:8px;">
                        <label for="comment">コメント</label>
                        <textarea id="comment" name="comment" rows="5" maxlength="500" required></textarea>
                    </div>
                    <div>
                        <button type="submit" class="samuraitravel-btn">投稿する</button>
                    </div>
                </form>
            </div>
        </section>
    </section>
</main>

<footer th:replace="~{fragment :: footer}"></footer>
</body>
</html>
